# CSS Split Example Project

The goal of this repository is to demonstrate CSS split with Webpack 4, mini-css-extract-plugin and
dynamic imports.

The idea is to discriminate the critical CSS by creating SASS files nameds `*.critical.scss`.

Critical CSS is typically used to support Server Side Rendering (SSR) version of the DOM generated by React.

- Critical CSS is extracted in one css file using 
[extract-text-webpack-plugin](https://github.com/webpack-contrib/extract-text-webpack-plugin)
- Non critical CSS is extracted in dynamically loaded chunks using
[mini-css-extract-plugin](https://github.com/webpack-contrib/mini-css-extract-plugin)

## Getting Started

```
npm install
npm run build
```

### Webpack Config

The modules are loaded like this (see `webpack.config.babel.js`);

```
{
  test: /\.critical\.scss$/,
  use: ExtractTextPlugin.extract(['css-loader', 'sass-loader']),
},
{
  test: /(?!\.critical)\.scss$/,
  exclude: /critical/,
  use: [MiniCssExtractPlugin.loader, 'css-loader', 'sass-loader'],
},
```

Then the assets are generated by the plugins:

```
// Non-critical CSS loaded dynamically using Webpack modules
new MiniCssExtractPlugin({
  filename: '[name].css',
  chunkFilename: '[name].css',
}),
// Critical CSS loaded statically, typically used for SSR.
new ExtractTextPlugin({
  filename: '[name].critical.css',
  allChunks: true,
}),
```

This outputs the following assets:

```
            Asset       Size  Chunks             Chunk Names
  MyComponent.css   63 bytes       0  [emitted]  MyComponent
   MyComponent.js  449 bytes       0  [emitted]  MyComponent
         main.css   44 bytes       1  [emitted]  main
          main.js    100 KiB       1  [emitted]  main
main.critical.css   86 bytes       1  [emitted]  main
       index.html  289 bytes          [emitted]
Entrypoint main = main.css main.js main.critical.css
```

Both `main.css` and `main.critical.css` should be loaded as `link` in the page. `main.css` could
however be deferred, as illustrated below.

```
<link href="main.critical.css" rel="stylesheet">
<link
    rel="stylesheet"
    href="main.css"
    media="none"
    onload="if(media!='screen')media='screen'">
<noscript>
    <link rel="stylesheet" href="main.css">
</noscript>
```

## Current issue

Unfortunately, `extract-text-weback-plugin` has an issue with the above approach.

When executing Webpack, you'll notice the following error:

```
let moduleSource = chunkModule.source(compilation.dependencyTemplates, compilation.runtimeTemplate);
                                     ^

TypeError: chunkModule.source is not a function
    at Function.renderExtractedChunk (node_modules\extract-text-webpack-plugin\dist\index
    .js:115:38)

```

You'll need a special version of `extract-text-weback-plugin` that ignores the chunk if 
`chunkModule.source` is not a function.
